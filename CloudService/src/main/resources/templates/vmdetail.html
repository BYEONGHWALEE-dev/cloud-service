<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VM ìƒì„¸ - Cloud Service</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
<!-- ë„¤ë¹„ê²Œì´ì…˜ -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="/dashboard">ğŸ–¥ï¸ Cloud Service</a>
        <div class="navbar-nav ms-auto">
            <a class="nav-link" href="/dashboard">ëŒ€ì‹œë³´ë“œ</a>
            <a class="nav-link" href="/logout">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div class="row">
        <!-- VM ì •ë³´ -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0" th:text="${vm.vmName}">VM Name</h4>
                    <span class="badge fs-6"
                          th:classappend="${vm.status.name() == 'RUNNING'} ? 'bg-success' : 'bg-secondary'"
                          th:text="${vm.status.description}">ìƒíƒœ</span>
                </div>
                <div class="card-body">
                    <table class="table">
                        <tr>
                            <th>VM ID</th>
                            <td th:text="${vm.id}">1</td>
                        </tr>
                        <tr>
                            <th>Proxmox VM ID</th>
                            <td th:text="${vm.proxmoxVmId}">100</td>
                        </tr>
                        <tr>
                            <th>ë‚´ë¶€ IP</th>
                            <td th:text="${vm.internalIp} ?: 'í• ë‹¹ ì¤‘...'">192.168.100.10</td>
                        </tr>
                        <tr th:if="${vm.spec != null}">
                            <th>CPU</th>
                            <td><span th:text="${vm.spec.cpuCores}">2</span> vCPU</td>
                        </tr>
                        <tr th:if="${vm.spec != null}">
                            <th>ë©”ëª¨ë¦¬</th>
                            <td><span th:text="${vm.spec.memoryMb}">2048</span> MB</td>
                        </tr>
                        <tr th:if="${vm.spec != null}">
                            <th>ë””ìŠ¤í¬</th>
                            <td><span th:text="${vm.spec.diskGb}">20</span> GB</td>
                        </tr>
                        <tr th:if="${vm.ssh != null}">
                            <th>SSH ì‚¬ìš©ì</th>
                            <td th:text="${vm.ssh.username}">ubuntu</td>
                        </tr>
                        <tr>
                            <th>ìƒì„±ì¼</th>
                            <td th:text="${#temporals.format(vm.createdAt, 'yyyy-MM-dd HH:mm')}">2025-01-01</td>
                        </tr>
                    </table>

                    <div class="d-flex gap-2 mt-3">
                        <button class="btn btn-success" id="startBtn"
                                th:disabled="${vm.status.name() == 'RUNNING'}"
                                th:onclick="'startVm(' + ${vm.id} + ')'">
                            <i class="bi bi-play-fill"></i> ì‹œì‘
                        </button>
                        <button class="btn btn-warning" id="stopBtn"
                                th:disabled="${vm.status.name() == 'STOPPED'}"
                                th:onclick="'stopVm(' + ${vm.id} + ')'">
                            <i class="bi bi-stop-fill"></i> ì •ì§€
                        </button>
                        <button class="btn btn-danger"
                                th:onclick="'deleteVm(' + ${vm.id} + ')'">
                            <i class="bi bi-trash"></i> ì‚­ì œ
                        </button>
                    </div>
                </div>
            </div>

            <!-- SSH ì ‘ì† ì •ë³´ -->
            <div class="card mt-3" th:if="${vm.status.name() == 'RUNNING'}">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ”— SSH ì ‘ì† ë°©ë²•</h5>
                </div>
                <div class="card-body">
                    <p class="mb-2">1. VPNì— ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”</p>
                    <p class="mb-2">2. ì•„ë˜ ëª…ë ¹ì–´ë¡œ SSH ì ‘ì†:</p>
                    <code class="d-block bg-dark text-light p-2 rounded"
                          th:text="'ssh ' + (${vm.ssh != null} ? ${vm.ssh.username} : 'ubuntu') + '@' + ${vm.internalIp}">
                        ssh ubuntu@192.168.100.10
                    </code>
                </div>
            </div>
        </div>

        <!-- ëª¨ë‹ˆí„°ë§ -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">ğŸ“Š ë¦¬ì†ŒìŠ¤ ëª¨ë‹ˆí„°ë§</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshMonitoring()">
                        <i class="bi bi-arrow-clockwise"></i> ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
                <div class="card-body" id="monitoringData">
                    <div th:if="${vm.status.name() != 'RUNNING'}" class="text-center text-muted py-4">
                        <i class="bi bi-power" style="font-size: 2rem;"></i>
                        <p class="mt-2">VMì´ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤</p>
                    </div>

                    <div th:if="${vm.status.name() == 'RUNNING'}" id="monitoringContent">
                        <div class="mb-4">
                            <div class="d-flex justify-content-between mb-1">
                                <span>CPU ì‚¬ìš©ë¥ </span>
                                <span id="cpuPercent">ë¡œë”© ì¤‘...</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar bg-primary" id="cpuBar" style="width: 0%"></div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="d-flex justify-content-between mb-1">
                                <span>ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ </span>
                                <span id="memPercent">ë¡œë”© ì¤‘...</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar bg-success" id="memBar" style="width: 0%"></div>
                            </div>
                        </div>

                        <div>
                            <p><strong>ê°€ë™ ì‹œê°„:</strong> <span id="uptime">-</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <a href="/dashboard" class="btn btn-secondary">â† ëª©ë¡ìœ¼ë¡œ</a>
    </div>
</div>

<script th:inline="javascript">
    const vmId = [[${vm.id}]];
    const vmStatus = [[${vm.status.name()}]];

    async function startVm(id) {
        if (!confirm('VMì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        const response = await fetch(`/api/vms/${id}/start`, { method: 'POST' });
        const data = await response.json();
        if (data.isSuccess) {
            alert('VMì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');
            location.reload();
        } else {
            alert('ì‹œì‘ ì‹¤íŒ¨: ' + data.message);
        }
    }

    async function stopVm(id) {
        if (!confirm('VMì„ ì •ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        const response = await fetch(`/api/vms/${id}/stop`, { method: 'POST' });
        const data = await response.json();
        if (data.isSuccess) {
            alert('VMì´ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            location.reload();
        } else {
            alert('ì •ì§€ ì‹¤íŒ¨: ' + data.message);
        }
    }

    async function deleteVm(id) {
        if (!confirm('ì •ë§ VMì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
        const response = await fetch(`/api/vms/${id}`, { method: 'DELETE' });
        const data = await response.json();
        if (data.isSuccess) {
            alert('VMì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.location.href = '/dashboard';
        } else {
            alert('ì‚­ì œ ì‹¤íŒ¨: ' + data.message);
        }
    }

    async function refreshMonitoring() {
        if (vmStatus !== 'RUNNING') return;

        try {
            const response = await fetch(`/api/vms/${vmId}/monitoring`);
            const data = await response.json();

            if (data.isSuccess) {
                const m = data.Result;
                document.getElementById('cpuPercent').textContent = m.cpuUsagePercent.toFixed(1) + '%';
                document.getElementById('cpuBar').style.width = m.cpuUsagePercent + '%';
                document.getElementById('memPercent').textContent =
                    m.memoryUsedMb + ' / ' + m.memoryTotalMb + ' MB (' + m.memoryUsagePercent.toFixed(1) + '%)';
                document.getElementById('memBar').style.width = m.memoryUsagePercent + '%';

                const hours = Math.floor(m.uptimeSeconds / 3600);
                const minutes = Math.floor((m.uptimeSeconds % 3600) / 60);
                document.getElementById('uptime').textContent = `${hours}ì‹œê°„ ${minutes}ë¶„`;
            }
        } catch (error) {
            console.error('ëª¨ë‹ˆí„°ë§ ì¡°íšŒ ì‹¤íŒ¨:', error);
        }
    }

    // ì´ˆê¸° ë¡œë”© ë° ìë™ ìƒˆë¡œê³ ì¹¨
    if (vmStatus === 'RUNNING') {
        refreshMonitoring();
        setInterval(refreshMonitoring, 10000);  // 10ì´ˆë§ˆë‹¤ ìƒˆë¡œê³ ì¹¨
    }
</script>
</body>
</html>