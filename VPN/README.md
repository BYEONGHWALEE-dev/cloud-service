# VPN Server with Software Enclave

λΌμ¦λ² λ¦¬νμ΄ κΈ°λ° κ²½λ‰ VPN μ„λ²„ - μ†ν”„νΈμ›¨μ–΄ Enclaveλ¥Ό ν™μ©ν• λ³΄μ• κ°•ν™” λ° tc QoS ν†µν•©

---

## π“‹ λ©μ°¨

- [ν”„λ΅μ νΈ κ°μ”](#ν”„λ΅μ νΈ-κ°μ”)
- [μ£Όμ” νΉμ§•](#μ£Όμ”-νΉμ§•)
- [μ‹μ¤ν… μ•„ν‚¤ν…μ²](#μ‹μ¤ν…-μ•„ν‚¤ν…μ²)
- [μ”κµ¬μ‚¬ν•­](#μ”κµ¬μ‚¬ν•­)
- [μ„¤μΉ λ°©λ²•](#μ„¤μΉ-λ°©λ²•)
- [μ‚¬μ© λ°©λ²•](#μ‚¬μ©-λ°©λ²•)
- [μ„¤μ • κ°€μ΄λ“](#μ„¤μ •-κ°€μ΄λ“)
- [ν”„λ΅ν† μ½ λ…μ„Έ](#ν”„λ΅ν† μ½-λ…μ„Έ)
- [λ³΄μ• κ³ λ ¤μ‚¬ν•­](#λ³΄μ•-κ³ λ ¤μ‚¬ν•­)
- [μ„±λ¥ λ²¤μΉλ§ν¬](#μ„±λ¥-λ²¤μΉλ§ν¬)
- [νΈλ¬λΈ”μν…](#νΈλ¬λΈ”μν…)
- [κΈ°μ—¬ λ°©λ²•](#κΈ°μ—¬-λ°©λ²•)
- [λΌμ΄μ„ μ¤](#λΌμ΄μ„ μ¤)

---

## π― ν”„λ΅μ νΈ κ°μ”

λ³Έ ν”„λ΅μ νΈλ” **λΌμ¦λ² λ¦¬νμ΄**μ—μ„ λ™μ‘ν•λ” κ²½λ‰ VPN μ„λ²„λ΅, λ‹¤μκ³Ό κ°™μ€ λ©ν‘λ¥Ό κ°€μ§€κ³  κ°λ°λμ—μµλ‹λ‹¤:

- **κµμ΅ λ©μ **: VPNμ λ‚΄λ¶€ λ™μ‘ μ›λ¦¬λ¥Ό μ €μμ¤€λ¶€ν„° μ΄ν•΄
- **λ³΄μ• κ°•ν™”**: μ†ν”„νΈμ›¨μ–΄ Enclave ν¨ν„΄μ„ ν†µν• μ•”νΈν™” ν‚¤ κ²©λ¦¬
- **QoS ν†µν•©**: Linux tc(Traffic Control)λ¥Ό ν™μ©ν• μ‚¬μ©μλ³„ λ€μ—­ν­ μ μ–΄
- **μ‹¤μ©μ„±**: μ‹¤μ  λ°°ν¬ κ°€λ¥ν• ν”„λ΅λ•μ… λ λ²¨ μ½”λ“

### μ™ μ΄ ν”„λ΅μ νΈλ¥Ό λ§λ“¤μ—λ‚μ”?

κΈ°μ΅΄ VPN μ†”λ£¨μ…(OpenVPN, WireGuard)μ€ ν›λ¥­ν•μ§€λ§, **"λΈ”λ™λ°•μ¤"**μ²λΌ λκ»΄μ§‘λ‹λ‹¤. λ³Έ ν”„λ΅μ νΈλ”:

1. **VPN ν”„λ΅ν† μ½μ„ μ§μ ‘ κµ¬ν„**ν•μ—¬ ν¨ν‚· λ λ²¨μ—μ„ μ΄ν•΄
2. **ν•λ“μ›¨μ–΄ Enclave κ°λ…μ„ μ†ν”„νΈμ›¨μ–΄λ΅ μ‹λ®¬λ μ΄μ…**ν•μ—¬ λ³΄μ• κ°•ν™”
3. **QoSλ¥Ό VPNκ³Ό ν†µν•©**ν•μ—¬ κ³µμ •ν• λ€μ—­ν­ λ¶„λ°°

---

## β¨ μ£Όμ” νΉμ§•

### 1. μ†ν”„νΈμ›¨μ–΄ Enclave μ•„ν‚¤ν…μ²

```
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚  Main Process (vpn-server)              β”‚
β”‚  - λ„¤νΈμ›ν¬ I/O                         β”‚
β”‚  - ν΄λΌμ΄μ–ΈνΈ κ΄€λ¦¬                      β”‚
β”‚  - QoS μ μ–΄                             β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
               β”‚ IPC (Unix Socket)
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β–Όβ”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚  Enclave Process (vpn-enclave)          β”‚
β”‚  - μ•”νΈν™”/λ³µνΈν™” μ „λ‹΄                   β”‚
β”‚  - ν‚¤ κ΄€λ¦¬ (λ©”λ¨λ¦¬μ—λ§ λ³΄κ΄€)           β”‚
β”‚  - mlock() + seccompλ΅ λ³΄νΈ             β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
```

**μ¥μ :**
- μ•”νΈν™” ν‚¤κ°€ Main ν”„λ΅μ„Έμ¤μ— λ…Έμ¶λμ§€ μ•μ
- λ©”λ¨λ¦¬ μ¤μ™‘ λ°©μ§€ (`mlock`)λ΅ λ””μ¤ν¬ μ μ¶ μ°¨λ‹¨
- μ‹μ¤ν…μ½ μ ν• (`seccomp`)μΌλ΅ κ³µκ²© ν‘λ©΄ μµμ†ν™”

### 2. Linux tc κΈ°λ° QoS

```bash
# μ‚¬μ©μλ³„ λ€μ—­ν­ μλ™ ν• λ‹Ή
User A (VIP):    5 Mbps (λ³΄μ¥) / 10 Mbps (μµλ€)
User B (μΌλ°):   3 Mbps (λ³΄μ¥) / 6 Mbps (μµλ€)
User C (κ²μ¤νΈ): 2 Mbps (λ³΄μ¥) / 4 Mbps (μµλ€)
```

**κΈ°μ :**
- HTB (Hierarchy Token Bucket) qdisc
- fq_codel νλ΅ μ§€μ—° μµμ†ν™”
- IP κΈ°λ° μλ™ λ¶„λ¥ (tc filter)

### 3. ν„λ€μ  μ•”νΈν™”

- **AEAD μ•”νΈν™”**: ChaCha20-Poly1305 (μΈμ¦ ν¬ν•¨)
- **ν‚¤ κµν™**: Curve25519 (ECDH)
- **μΈμ¦**: SHA256 κΈ°λ° ν† ν°
- **μ¬μ „μ†΅ κ³µκ²© λ°©μ§€**: μ‹ν€€μ¤ λ²νΈ + νƒ€μ„μ¤νƒ¬ν”„

### 4. κ²½λ‰ μ„¤κ³„

- **λ©”λ¨λ¦¬ μ‚¬μ©λ‰**: < 50 MB (Enclave ν¬ν•¨)
- **CPU μ‚¬μ©λ¥ **: μ•”νΈν™” μ‹ 60-80% (λΌμ¦λ² λ¦¬νμ΄ 4B)
- **μµλ€ μ²λ¦¬λ‰**: 500-800 Mbps (μ•”νΈν™” ν¬ν•¨)
- **λ™μ‹ ν΄λΌμ΄μ–ΈνΈ**: 100-200κ°

---

## π—οΈ μ‹μ¤ν… μ•„ν‚¤ν…μ²

### μ „μ²΄ κµ¬μ΅°λ„

```
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚                   μΈν„°λ„· (UDP :51820)                     β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                     β”‚
                     β–Ό
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚              λΌμ¦λ² λ¦¬νμ΄ VPN μ„λ²„                        β”‚
β”‚                                                           β”‚
β”‚  β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”     β”‚
β”‚  β”‚  Main Process (vpn-server)                     β”‚     β”‚
β”‚  β”‚  β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”  β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”  β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”     β”‚     β”‚
β”‚  β”‚  β”‚ UDP      β”‚  β”‚ TUN      β”‚  β”‚ QoS      β”‚     β”‚     β”‚
β”‚  β”‚  β”‚ Server   β”‚  β”‚ Manager  β”‚  β”‚ Control  β”‚     β”‚     β”‚
β”‚  β”‚  β””β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”  β””β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”  β””β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”     β”‚     β”‚
β”‚  β””β”€β”€β”€β”€β”€β”€β”€β”Όβ”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”Όβ”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”Όβ”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”     β”‚
β”‚          β”‚             β”‚             β”‚                   β”‚
β”‚          β”‚             β”‚             β”‚                   β”‚
β”‚  β”β”€β”€β”€β”€β”€β”€β”€β–Όβ”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β–Όβ”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β–Όβ”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”     β”‚
β”‚  β”‚  Enclave Process (vpn-enclave)                 β”‚     β”‚
β”‚  β”‚  β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”  β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”  β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”     β”‚     β”‚
β”‚  β”‚  β”‚ Crypto   β”‚  β”‚ Key Mgmt β”‚  β”‚ Auth     β”‚     β”‚     β”‚
β”‚  β”‚  β”‚ Engine   β”‚  β”‚          β”‚  β”‚ Handler  β”‚     β”‚     β”‚
β”‚  β”‚  β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”  β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”  β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”     β”‚     β”‚
β”‚  β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”     β”‚
β”‚                                                           β”‚
β”‚  β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”     β”‚
β”‚  β”‚  TUN Interface (tun0)                          β”‚     β”‚
β”‚  β”‚  IP: 10.8.0.1/24                               β”‚     β”‚
β”‚  β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”     β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”Όβ”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                β”‚
                β–Ό
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚         λ‚΄λ¶€ λ„¤νΈμ›ν¬ (192.168.100.0/24)                 β”‚
β”‚         VM #1, VM #2, VM #3...                           β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
```

### ν¨ν‚· νλ¦„

#### ν΄λΌμ΄μ–ΈνΈ β†’ μ„λ²„ (μ•”νΈν™”)

```
[ν΄λΌμ΄μ–ΈνΈ]
  App λ°μ΄ν„° μƒμ„±
    β†“
  TUN μΈν„°νμ΄μ¤ (tun0)
    β†“
  VPN ν΄λΌμ΄μ–ΈνΈ
    β”β”€ μ•”νΈν™” (ChaCha20-Poly1305)
    β””β”€ VPN ν—¤λ” μ¶”κ°€
    β†“
  UDP μ†μΌ“ β†’ μΈν„°λ„·
    β†“
[μ„λ²„]
  UDP μ†μΌ“ μμ‹ 
    β†“
  Main Process
    β”β”€ ν—¤λ” νμ‹±
    β””β”€ Enclaveμ—κ² λ³µνΈν™” μ”μ²­ (IPC)
    β†“
  Enclave Process
    β”β”€ λ³µνΈν™”
    β””β”€ μ›λ³Έ ν¨ν‚· λ°ν™
    β†“
  Main Process
    β”β”€ QoS λ¶„λ¥ (tc filter)
    β””β”€ TUN μΈν„°νμ΄μ¤λ΅ μ „λ‹¬
    β†“
  λ‚΄λ¶€ λ„¤νΈμ›ν¬ (VM μ ‘κ·Ό)
```

#### μ„λ²„ β†’ ν΄λΌμ΄μ–ΈνΈ (μ‘λ‹µ)

```
[μ„λ²„]
  TUN μΈν„°νμ΄μ¤ μμ‹  (VM β†’ VPN μ„λ²„)
    β†“
  Main Process
    β”β”€ λ©μ μ§€ ν΄λΌμ΄μ–ΈνΈ μ΅°ν
    β””β”€ Enclaveμ—κ² μ•”νΈν™” μ”μ²­
    β†“
  Enclave Process
    β”β”€ μ•”νΈν™”
    β””β”€ μ•”νΈν™”λ ν¨ν‚· λ°ν™
    β†“
  Main Process
    β””β”€ UDP μ†μΌ“μΌλ΅ μ „μ†΅
    β†“
  μΈν„°λ„·
    β†“
[ν΄λΌμ΄μ–ΈνΈ]
  UDP μμ‹  β†’ λ³µνΈν™” β†’ TUN β†’ App
```

---

## π“¦ μ”κµ¬μ‚¬ν•­

### ν•λ“μ›¨μ–΄

- **μµμ†**: λΌμ¦λ² λ¦¬νμ΄ 3B+ (RAM 1GB)
- **κ¶μ¥**: λΌμ¦λ² λ¦¬νμ΄ 4B (RAM 4GB)
- **λ„¤νΈμ›ν¬**: Ethernet λλ” WiFi
- **μ €μ¥κ³µκ°„**: 500MB μ΄μƒ

### μ†ν”„νΈμ›¨μ–΄

#### μ„λ²„ (λΌμ¦λ² λ¦¬νμ΄)

```bash
OS: Raspbian 11 (Bullseye) μ΄μƒ / Ubuntu 22.04 LTS
Kernel: 5.10+ (TUN/TAP μ§€μ›)
```

**ν•„μ ν¨ν‚¤μ§€:**
```bash
- gcc (10.0+)
- make
- libsodium-dev (μ•”νΈν™” λΌμ΄λΈλ¬λ¦¬)
- iproute2 (tc λ…λ Ήμ–΄)
- iptables
```

**μ„ νƒ ν¨ν‚¤μ§€:**
```bash
- libseccomp-dev (μ‹μ¤ν…μ½ ν•„ν„°λ§)
- valgrind (λ©”λ¨λ¦¬ λ””λ²„κΉ…)
```

#### ν΄λΌμ΄μ–ΈνΈ

- **Linux**: Ubuntu 20.04+, Debian 11+
- **Windows**: Windows 10/11 (WSL2 λλ” λ„¤μ΄ν‹°λΈ λΉλ“)
- **macOS**: macOS 11+ (Homebrew)

---

## π€ μ„¤μΉ λ°©λ²•

### 1. μ €μ¥μ† ν΄λ΅ 

```bash
git clone https://github.com/yourusername/vpn-server.git
cd vpn-server
```

### 2. μμ΅΄μ„± μ„¤μΉ

#### λΌμ¦λ² λ¦¬νμ΄ (Raspbian/Ubuntu)

```bash
sudo apt update
sudo apt install -y build-essential libsodium-dev iproute2 iptables libseccomp-dev
```

#### macOS

```bash
brew install libsodium libseccomp
```

### 3. λΉλ“

```bash
make all
```

λΉλ“ κ²°κ³Ό:
```
bin/vpn-server    # μ„λ²„ λ©”μΈ ν”„λ΅μ„Έμ¤
bin/vpn-enclave   # Enclave ν”„λ΅μ„Έμ¤
bin/vpn-client    # ν΄λΌμ΄μ–ΈνΈ ν”„λ΅κ·Έλ¨
```

### 4. μ„¤μΉ (μ„ νƒμ‚¬ν•­)

```bash
sudo make install
# /usr/local/bin/vpn-server
# /usr/local/bin/vpn-enclave
# /usr/local/bin/vpn-client
```

---

## π® μ‚¬μ© λ°©λ²•

### μ„λ²„ μ‹¤ν–‰

#### 1. μ„¤μ • νμΌ μμ •

```bash
cp config/server.conf.example config/server.conf
nano config/server.conf
```

**config/server.conf:**
```ini
[server]
listen_port = 51820
tun_device = tun0
tun_ip = 10.8.0.1
tun_netmask = 24

[network]
client_ip_pool_start = 10.8.0.10
client_ip_pool_end = 10.8.0.254

[qos]
enabled = true
total_bandwidth = 50Mbps
default_class = 1:20
default_rate = 3Mbps
default_ceil = 6Mbps

[security]
enclave_socket = /tmp/vpn_enclave.sock
max_clients = 200
session_timeout = 3600

[logging]
level = INFO
file = /var/log/vpn-server.log
```

#### 2. μ„λ²„ μ‹μ‘

```bash
sudo ./bin/vpn-server -c config/server.conf
```

**μ¶λ ¥ μμ‹:**
```
[INFO] Starting VPN server...
[INFO] Enclave process started (PID: 1234)
[INFO] TUN interface created: tun0
[INFO] TUN IP configured: 10.8.0.1/24
[INFO] QoS initialized on tun0
[INFO] UDP server listening on port 51820
[INFO] VPN server is running...
```

#### 3. λ°λ¬ λ¨λ“ (λ°±κ·ΈλΌμ΄λ“ μ‹¤ν–‰)

```bash
sudo ./bin/vpn-server -c config/server.conf -d
```

### ν΄λΌμ΄μ–ΈνΈ μ—°κ²°

#### 1. μ„¤μ • νμΌ μƒμ„±

```bash
cp config/client.conf.template config/my-client.conf
nano config/my-client.conf
```

**config/my-client.conf:**
```ini
[client]
server_ip = 192.168.1.100  # μ„λ²„ IP
server_port = 51820
username = user1
auth_token = your_token_here

[network]
tun_device = tun0
```

#### 2. ν΄λΌμ΄μ–ΈνΈ μ‹¤ν–‰

```bash
sudo ./bin/vpn-client -c config/my-client.conf
```

**μ¶λ ¥ μμ‹:**
```
[INFO] Connecting to 192.168.1.100:51820...
[INFO] Authentication successful
[INFO] VPN IP assigned: 10.8.0.10
[INFO] TUN interface configured
[INFO] Connected! You can now access internal network.
```

#### 3. μ—°κ²° ν™•μΈ

```bash
# VPN IP ν™•μΈ
ip addr show tun0

# λ‚΄λ¶€ λ„¤νΈμ›ν¬ μ ‘κ·Ό ν…μ¤νΈ
ping 192.168.100.10  # VM #1
ssh user@192.168.100.10
```

---

## β™οΈ μ„¤μ • κ°€μ΄λ“

### QoS ν΄λμ¤ μ„¤μ •

μ‚¬μ©μλ³„λ΅ λ‹¤λ¥Έ QoS ν΄λμ¤λ¥Ό ν• λ‹Ήν•  μ μμµλ‹λ‹¤.

**config/qos_classes.conf:**
```ini
[class:vip]
classid = 1:10
rate = 5Mbps
ceil = 10Mbps
priority = 1

[class:normal]
classid = 1:20
rate = 3Mbps
ceil = 6Mbps
priority = 2

[class:guest]
classid = 1:30
rate = 2Mbps
ceil = 4Mbps
priority = 3

[user:alice]
vpn_ip = 10.8.0.10
class = vip

[user:bob]
vpn_ip = 10.8.0.20
class = normal

[user:guest1]
vpn_ip = 10.8.0.100
class = guest
```

### λ°©ν™”λ²½ μ„¤μ •

#### iptables κ·μΉ™ μ¶”κ°€

```bash
# IP ν¬μ›λ”© ν™μ„±ν™”
sudo sysctl -w net.ipv4.ip_forward=1
echo "net.ipv4.ip_forward=1" | sudo tee -a /etc/sysctl.conf

# NAT μ„¤μ • (VPN β†’ λ‚΄λ¶€λ§)
sudo iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE

# VPN ν¬νΈ κ°λ°©
sudo iptables -A INPUT -p udp --dport 51820 -j ACCEPT

# μ„¤μ • μ €μ¥
sudo iptables-save | sudo tee /etc/iptables/rules.v4
```

### μΈμ¦ ν† ν° μƒμ„±

```bash
# SHA256 κΈ°λ° ν† ν° μƒμ„±
echo -n "username:password" | sha256sum | awk '{print $1}'
```

---

## π“΅ ν”„λ΅ν† μ½ λ…μ„Έ

### VPN ν¨ν‚· κµ¬μ΅°

#### κ³µν†µ ν—¤λ” (16 bytes)

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|     Type      |    Version    |            Length             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         Sequence Number                       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         Timestamp (ms)                        |
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

- **Type**: ν¨ν‚· μΆ…λ¥
  - `0x01`: CONNECT_REQ
  - `0x02`: CONNECT_RESP
  - `0x03`: DATA
  - `0x04`: PING
  - `0x05`: PONG
  - `0x06`: DISCONNECT
- **Version**: ν”„λ΅ν† μ½ λ²„μ „ (ν„μ¬ `0x01`)
- **Length**: νμ΄λ΅λ“ κΈΈμ΄ (bytes)
- **Sequence**: μ¬μ „μ†΅ κ³µκ²© λ°©μ§€μ© μ‹ν€€μ¤ λ²νΈ
- **Timestamp**: UNIX νƒ€μ„μ¤νƒ¬ν”„ (λ°€λ¦¬μ΄)

#### λ°μ΄ν„° ν¨ν‚· (Type=0x03)

```
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                     VPN Header (16 bytes)                     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                     Nonce (12 bytes)                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                     Auth Tag (16 bytes)                       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                     Encrypted Payload                         |
|                     (variable length)                         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### μ—°κ²° ν”λ΅μ°

```
Client                                Server
  β”‚                                     β”‚
  β”β”€ CONNECT_REQ β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β–Ίβ”‚
  β”‚  (username, auth_token, public_key) β”‚
  β”‚                                     β”‚
  β”‚                                     β”β”€ Enclave: μΈμ¦ ν™•μΈ
  β”‚                                     β”β”€ IP ν• λ‹Ή (10.8.0.x)
  β”‚                                     β””β”€ κ³µμ ν‚¤ μƒμ„± (ECDH)
  β”‚                                     β”‚
  β”‚β—„β”€ CONNECT_RESP β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¤
  β”‚  (status, vpn_ip, server_public_key)β”‚
  β”‚                                     β”‚
  β”β”€ κ³µμ ν‚¤ μƒμ„± (ECDH)                 β”‚
  β”‚                                     β”‚
  β”β”€ DATA (μ•”νΈν™”) β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β–Ίβ”‚
  β”‚                                     β”‚
  β”‚β—„β”€ DATA (μ•”νΈν™”) β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¤
  β”‚                                     β”‚
```

---

## π”’ λ³΄μ• κ³ λ ¤μ‚¬ν•­

### Enclave ν”„λ΅μ„Έμ¤ λ³΄νΈ

1. **λ©”λ¨λ¦¬ κ²©λ¦¬**
   - `mlock()`: λ©”λ¨λ¦¬λ¥Ό RAMμ— κ³ μ •, μ¤μ™‘ λ°©μ§€
   - μ½”μ–΄ λ¤ν”„ λΉ„ν™μ„±ν™”: ν‚¤ μ μ¶ μ°¨λ‹¨

2. **μ‹μ¤ν…μ½ μ ν• (seccomp)**
   - ν—μ© λ¦¬μ¤νΈ: `read`, `write`, `sendto`, `recvfrom`
   - μ°¨λ‹¨: `open`, `execve`, `fork`, λ„¤νΈμ›ν¬ μ ‘κ·Ό λ“±

3. **ν”„λ΅μ„Έμ¤ κ°„ ν†µμ‹  (IPC)**
   - Unix Domain Socket μ‚¬μ© (TCP/IPλ³΄λ‹¤ μ•μ „)
   - κ¶ν• κ²€μ¦: μ†μΌ“ νμΌ κ¶ν• `0600`

### μ•”νΈν™” ν‚¤ κ΄€λ¦¬

- **ν‚¤ μƒλ…μ£ΌκΈ°**: λ©”λ¨λ¦¬μ—λ§ μ΅΄μ¬, λ””μ¤ν¬ μ €μ¥ μ—†μ
- **ν‚¤ κµν™**: Curve25519 ECDH (μ™„μ „ μλ°©ν–¥ λΉ„λ°€μ„±)
- **ν‚¤ νμƒ**: HKDF-SHA256
- **ν‚¤ μ κ±°**: `memset(key, 0, 32)` + `munlock()`

### μ¬μ „μ†΅ κ³µκ²© λ°©μ§€

- **μ‹ν€€μ¤ λ²νΈ**: λ‹¨μ΅° μ¦κ°€, μ¤‘λ³µ κ±°λ¶€
- **νƒ€μ„μ¤νƒ¬ν”„**: 5μ΄ μ΄μƒ μ¤λλ ν¨ν‚· κ±°λ¶€
- **Nonce**: ν¨ν‚·λ§λ‹¤ κ³ μ κ°’ (counter + random)

### μ•λ ¤μ§„ μ μ•½μ‚¬ν•­

β οΈ **λ³Έ κµ¬ν„μ€ κµμ΅ λ©μ μ…λ‹λ‹¤.** ν”„λ΅λ•μ… ν™κ²½μ—μ„λ”:
- μ •κΈ°μ μΈ λ³΄μ• κ°μ‚¬ ν•„μ”
- ν‚¤ κµν™μ— μΈμ¦μ„ κΈ°λ° PKI κ¶μ¥
- DDoS λ°©μ–΄ λ©”μ»¤λ‹μ¦ μ¶”κ°€ κ¶μ¥

---

## π“ μ„±λ¥ λ²¤μΉλ§ν¬

### ν…μ¤νΈ ν™κ²½

- **ν•λ“μ›¨μ–΄**: λΌμ¦λ² λ¦¬νμ΄ 4B (4GB RAM)
- **OS**: Raspbian 11 (Bullseye)
- **λ„¤νΈμ›ν¬**: Gigabit Ethernet
- **λ„κµ¬**: `iperf3`, `tc`

### κ²°κ³Ό

| ν•­λ© | κ°’ |
|------|-----|
| μµλ€ μ²λ¦¬λ‰ (μ•”νΈν™” O) | 650 Mbps |
| μµλ€ μ²λ¦¬λ‰ (μ•”νΈν™” X) | 920 Mbps |
| CPU μ‚¬μ©λ¥  (ν¬ν™” μƒνƒ) | 75% |
| λ©”λ¨λ¦¬ μ‚¬μ©λ‰ | 45 MB (Enclave ν¬ν•¨) |
| ν‰κ·  μ§€μ—° (Latency) | 2.5 ms |
| μµλ€ λ™μ‹ ν΄λΌμ΄μ–ΈνΈ | 150κ° |

### QoS ν¨κ³Ό

| μ§€ν‘ | QoS λΉ„ν™μ„±ν™” | QoS ν™μ„±ν™” |
|------|-------------|-----------|
| κ³µμ •μ„± μ§€μ (Jain's Index) | 0.65 | 0.92 |
| λ€μ—­ν­ λ³΄μ¥λ¥  | 78% | 96% |
| ν¨ν‚· μ†μ‹¤λ¥  | 3.2% | 0.8% |

---

## π› νΈλ¬λΈ”μν…

### λ¬Έμ : TUN μΈν„°νμ΄μ¤ μƒμ„± μ‹¤ν¨

```bash
[ERROR] Failed to create TUN interface: Permission denied
```

**ν•΄κ²°:**
```bash
# root κ¶ν• ν•„μ”
sudo ./bin/vpn-server -c config/server.conf

# λλ” CAP_NET_ADMIN κ¶ν• λ¶€μ—¬
sudo setcap cap_net_admin=eip ./bin/vpn-server
```

### λ¬Έμ : Enclave ν”„λ΅μ„Έμ¤ μ‹μ‘ μ‹¤ν¨

```bash
[ERROR] Failed to start enclave process
```

**ν•΄κ²°:**
```bash
# Unix μ†μΌ“ κ¶ν• ν™•μΈ
ls -l /tmp/vpn_enclave.sock

# μ΄μ „ μ†μΌ“ νμΌ μ‚­μ 
sudo rm /tmp/vpn_enclave.sock

# SELinux/AppArmor ν™•μΈ (μ„ νƒ)
sudo setenforce 0  # SELinux
```

### λ¬Έμ : QoS μ„¤μ • μ‹¤ν¨

```bash
[WARN] Failed to setup QoS: Command failed
```

**ν•΄κ²°:**
```bash
# tc λ…λ Ήμ–΄ ν™•μΈ
which tc

# κΈ°μ΅΄ qdisc μ κ±°
sudo tc qdisc del dev tun0 root

# μλ™μΌλ΅ QoS μ„¤μ • ν…μ¤νΈ
sudo tc qdisc add dev tun0 root handle 1: htb
```

### λ¬Έμ : ν΄λΌμ΄μ–ΈνΈ μ—°κ²° νƒ€μ„μ•„μ›ƒ

```bash
[ERROR] Connection timeout
```

**ν•΄κ²°:**
1. **λ°©ν™”λ²½ ν™•μΈ**
   ```bash
   # μ„λ²„μ—μ„
   sudo iptables -L -n | grep 51820
   
   # UDP ν¬νΈ μ—΄κΈ°
   sudo iptables -A INPUT -p udp --dport 51820 -j ACCEPT
   ```

2. **λ„¤νΈμ›ν¬ μ—°κ²° ν™•μΈ**
   ```bash
   ping <server_ip>
   nc -vzu <server_ip> 51820
   ```

3. **μ„λ²„ λ΅κ·Έ ν™•μΈ**
   ```bash
   tail -f /var/log/vpn-server.log
   ```

---

## π¤ κΈ°μ—¬ λ°©λ²•

κΈ°μ—¬λ¥Ό ν™μν•©λ‹λ‹¤! λ‹¤μ μ μ°¨λ¥Ό λ”°λΌμ£Όμ„Έμ”:

1. **Fork** μ €μ¥μ†
2. **Feature λΈλμΉ μƒμ„±** (`git checkout -b feature/amazing-feature`)
3. **μ»¤λ°‹** (`git commit -m 'Add some amazing feature'`)
4. **Push** (`git push origin feature/amazing-feature`)
5. **Pull Request μƒμ„±**

### μ½”λ”© μ¤νƒ€μΌ

- C99 ν‘μ¤€ μ¤€μ
- λ“¤μ—¬μ“°κΈ°: 4 spaces
- ν•¨μλ…: `snake_case`
- μƒμ: `UPPER_CASE`

### ν…μ¤νΈ

```bash
make test
```

---

##  μ°Έκ³  μλ£

### ν”„λ΅ν† μ½

- [RFC 5246: TLS 1.2](https://tools.ietf.org/html/rfc5246)
- [RFC 7539: ChaCha20-Poly1305](https://tools.ietf.org/html/rfc7539)
- [RFC 7748: Curve25519](https://tools.ietf.org/html/rfc7748)

### Linux λ„¤νΈμ›ν‚Ή

- [TUN/TAP μΈν„°νμ΄μ¤](https://www.kernel.org/doc/Documentation/networking/tuntap.txt)
- [Linux Advanced Routing & Traffic Control](https://lartc.org/)
- [tc (Traffic Control) man page](https://man7.org/linux/man-pages/man8/tc.8.html)

### λ³΄μ•

- [seccomp κ°€μ΄λ“](https://www.kernel.org/doc/html/latest/userspace-api/seccomp_filter.html)
- [Intel SGX κ°μ”](https://software.intel.com/content/www/us/en/develop/topics/software-guard-extensions.html)

---

**Version**: 1.0.0  
**Last Updated**: 2024-12-15
