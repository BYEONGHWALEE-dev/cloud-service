# Makefile

CC = gcc
CFLAGS = -Wall -Wextra -std=c99 -D_DEFAULT_SOURCE -I include
LDFLAGS = -lsodium

# ë””ë ‰í† ë¦¬
SRC_DIR = src
BUILD_DIR = bin
INCLUDE_DIR = include

# íƒ€ê²Ÿ
.PHONY: all clean test help

all: $(BUILD_DIR)/tun_test $(BUILD_DIR)/vpn_server $(BUILD_DIR)/udp_test_client $(BUILD_DIR)/vpn_enclave $(BUILD_DIR)/test_enclave_ipc

# TUN í…ŒìŠ¤íŠ¸ í”„ë¡œê·¸ë¨ (ê¸°ì¡´)
$(BUILD_DIR)/tun_test: $(SRC_DIR)/server/tun_test.c $(SRC_DIR)/server/tun_manager.c
	@mkdir -p $(BUILD_DIR)
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)
	@echo "âœ… Build complete: $@"

# VPN ì„œë²„ (ë©”ì¸)
$(BUILD_DIR)/vpn_server: $(SRC_DIR)/server/vpn_server.c \
                          $(SRC_DIR)/server/tun_manager.c \
                          $(SRC_DIR)/server/udp_server.c \
                          $(SRC_DIR)/server/client_manager.c \
                          $(SRC_DIR)/server/enclave.c \
                          $(SRC_DIR)/server/enclave_client.c \
                          $(SRC_DIR)/common/protocol.c \
                          $(SRC_DIR)/common/ipc_protocol.c
	@mkdir -p $(BUILD_DIR)
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)
	@echo "âœ… Build complete: $@"

# VPN Enclave í”„ë¡œì„¸ìŠ¤ (NEW!)
$(BUILD_DIR)/vpn_enclave: $(SRC_DIR)/enclave/enclave_main.c \
                           $(SRC_DIR)/enclave/crypto.c \
                           $(SRC_DIR)/enclave/key_manager.c \
                           $(SRC_DIR)/common/ipc_protocol.c
	@mkdir -p $(BUILD_DIR)
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)
	@echo "âœ… Build complete: $@"

# UDP í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸
$(BUILD_DIR)/udp_test_client: $(SRC_DIR)/client/udp_test_client.c \
                               $(SRC_DIR)/common/protocol.c
	@mkdir -p $(BUILD_DIR)
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)
	@echo "âœ… Build complete: $@"
# Enclave IPC í…ŒìŠ¤íŠ¸
$(BUILD_DIR)/test_enclave_ipc: $(SRC_DIR)/server/test_enclave_ipc.c \
                                $(SRC_DIR)/server/enclave_client.c \
                                $(SRC_DIR)/common/ipc_protocol.c
	@mkdir -p $(BUILD_DIR)
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)
	@echo "âœ… Build complete: $@"

# í…ŒìŠ¤íŠ¸ ì‹¤í–‰
test:
	@echo "VPN Server Test Commands:"
	@echo "  sudo ./bin/vpn_enclave         # Enclave ë‹¨ë… ì‹¤í–‰"
	@echo "  sudo ./bin/vpn_server          # VPN ì„œë²„ (Enclave ìë™ ì‹œì‘)"
	@echo "  ./bin/udp_test_client 127.0.0.1  # í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸"

# ì •ë¦¬
clean:
	rm -rf $(BUILD_DIR)/*
	rm -f /tmp/vpn-enclave.sock
	@echo "ğŸ§¹ Clean complete"

# ë„ì›€ë§
help:
	@echo "VPN Server Build System"
	@echo ""
	@echo "Targets:"
	@echo "  all            - Build all targets"
	@echo "  vpn_enclave    - Build Enclave process only"
	@echo "  vpn_server     - Build VPN server"
	@echo "  test           - Show test commands"
	@echo "  clean          - Remove built files"
