# Makefile

CC = gcc
CFLAGS = -Wall -Wextra -std=c99 -D_DEFAULT_SOURCE -I include
LDFLAGS = -lsodium

# λ””λ ‰ν† λ¦¬
SRC_DIR = src
BUILD_DIR = bin
INCLUDE_DIR = include

# νƒ€κ²
.PHONY: all clean test help

all: $(BUILD_DIR)/tun_test \
     $(BUILD_DIR)/vpn_server \
     $(BUILD_DIR)/udp_test_client \
     $(BUILD_DIR)/vpn_enclave \
     $(BUILD_DIR)/test_enclave_ipc \
     $(BUILD_DIR)/vpn_client

# TUN ν…μ¤νΈ ν”„λ΅κ·Έλ¨ (κΈ°μ΅΄)
$(BUILD_DIR)/tun_test: $(SRC_DIR)/server/tun_test.c $(SRC_DIR)/server/tun_manager.c
	@mkdir -p $(BUILD_DIR)
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)
	@echo "β… Build complete: $@"

# VPN μ„λ²„ (λ©”μΈ)
$(BUILD_DIR)/vpn_server: $(SRC_DIR)/server/vpn_server.c \
                          $(SRC_DIR)/server/tun_manager.c \
                          $(SRC_DIR)/server/udp_server.c \
                          $(SRC_DIR)/server/client_manager.c \
                          $(SRC_DIR)/server/enclave.c \
                          $(SRC_DIR)/server/enclave_client.c \
                          $(SRC_DIR)/common/protocol.c \
                          $(SRC_DIR)/common/ipc_protocol.c
	@mkdir -p $(BUILD_DIR)
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)
	@echo "β… Build complete: $@"

# VPN Enclave ν”„λ΅μ„Έμ¤ (NEW!)
$(BUILD_DIR)/vpn_enclave: $(SRC_DIR)/enclave/enclave_main.c \
                           $(SRC_DIR)/enclave/crypto.c \
                           $(SRC_DIR)/enclave/key_manager.c \
                           $(SRC_DIR)/common/ipc_protocol.c
	@mkdir -p $(BUILD_DIR)
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)
	@echo "β… Build complete: $@"

# VPN ν΄λΌμ΄μ–ΈνΈ (μ•”νΈν™” μ§€μ›)
$(BUILD_DIR)/vpn_client: $(SRC_DIR)/client/vpn_client.c \
                          $(SRC_DIR)/server/tun_manager.c \
                          $(SRC_DIR)/enclave/crypto.c \
                          $(SRC_DIR)/common/protocol.c \
                          $(SRC_DIR)/common/config.c \
                          $(SRC_DIR)/common/logger.c
	@mkdir -p $(BUILD_DIR)
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)
	@echo "β… Build complete: $@"

# UDP ν…μ¤νΈ ν΄λΌμ΄μ–ΈνΈ
$(BUILD_DIR)/udp_test_client: $(SRC_DIR)/client/udp_test_client.c \
                               $(SRC_DIR)/common/protocol.c
	@mkdir -p $(BUILD_DIR)
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)
	@echo "β… Build complete: $@"
# Enclave IPC ν…μ¤νΈ
$(BUILD_DIR)/test_enclave_ipc: $(SRC_DIR)/server/test_enclave_ipc.c \
                                $(SRC_DIR)/server/enclave_client.c \
                                $(SRC_DIR)/common/ipc_protocol.c
	@mkdir -p $(BUILD_DIR)
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)
	@echo "β… Build complete: $@"

# ν…μ¤νΈ μ‹¤ν–‰
test:
	@echo "VPN Server Test Commands:"
	@echo "  sudo ./bin/vpn_enclave         # Enclave λ‹¨λ… μ‹¤ν–‰"
	@echo "  sudo ./bin/vpn_server          # VPN μ„λ²„ (Enclave μλ™ μ‹μ‘)"
	@echo "  ./bin/udp_test_client 127.0.0.1  # ν…μ¤νΈ ν΄λΌμ΄μ–ΈνΈ"

# μ •λ¦¬
clean:
	rm -rf $(BUILD_DIR)/*
	rm -f /tmp/vpn-enclave.sock
	@echo "π§Ή Clean complete"

# λ„μ›€λ§
help:
	@echo "VPN Server Build System"
	@echo ""
	@echo "Targets:"
	@echo "  all            - Build all targets"
	@echo "  vpn_enclave    - Build Enclave process only"
	@echo "  vpn_server     - Build VPN server"
	@echo "  test           - Show test commands"
	@echo "  clean          - Remove built files"
